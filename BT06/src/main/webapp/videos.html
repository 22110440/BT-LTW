<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Videos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">
<h1 class="mb-4">Video Management</h1>

<form id="formVideo" class="mb-3">
  <input type="hidden" id="id">
  <div class="mb-2">
    <label class="form-label">Title</label>
    <input type="text" id="title" class="form-control" required>
  </div>
  <div class="mb-2">
    <label class="form-label">URL</label>
    <input type="url" id="url" class="form-control" required>
  </div>
  <div class="mb-2">
    <label class="form-label">Category</label>
    <select id="category" class="form-select"></select>
  </div>
  <button type="submit" class="btn btn-primary">Save</button>
</form>

<input type="text" id="search" class="form-control mb-3" placeholder="Search by title...">

<table class="table table-bordered">
  <thead>
  <tr><th>ID</th><th>Title</th><th>URL</th><th>Category</th><th>Actions</th></tr>
  </thead>
  <tbody id="tblVideos"></tbody>
</table>

<script>
  const API = '/api/videos';
  const API_CAT = '/api/categories';

  async function loadCategories() {
    const res=await fetch(API_CAT);
    const cats=await res.json();
    const sel=document.getElementById('category');
    sel.innerHTML='';
    cats.forEach(c=>{
      sel.innerHTML+=`<option value="${c.id}">${c.name}</option>`;
    });
  }

  async function loadVideos(){
    const res=await fetch(API);
    render(await res.json());
  }

  function render(data){
    const tbody=document.getElementById('tblVideos');
    tbody.innerHTML='';
    data.forEach(v=>{
      tbody.innerHTML+=`
    <tr>
      <td>${v.id}</td>
      <td>${v.title}</td>
      <td><a href="${v.url}" target="_blank">${v.url}</a></td>
      <td>${v.category? v.category.name:''}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="edit(${v.id})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="remove(${v.id})">Delete</button>
      </td>
    </tr>`;
    });
  }

  document.getElementById('formVideo').onsubmit=async(e)=>{
    e.preventDefault();
    const id=document.getElementById('id').value;
    const payload={
      title:document.getElementById('title').value,
      url:document.getElementById('url').value,
      category:{id:Number(document.getElementById('category').value)}
    };
    await fetch(id?API+'/'+id:API,{
      method:id?'PUT':'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    e.target.reset(); document.getElementById('id').value='';
    loadVideos();
  };

  async function edit(id){
    const res=await fetch(API+'/'+id);
    const v=await res.json();
    document.getElementById('id').value=v.id;
    document.getElementById('title').value=v.title;
    document.getElementById('url').value=v.url;
    document.getElementById('category').value=v.category?.id||'';
  }

  async function remove(id){
    if(confirm('Delete?')){
      await fetch(API+'/'+id,{method:'DELETE'});
      loadVideos();
    }
  }

  document.getElementById('search').oninput=async(e)=>{
    const q=e.target.value;
    if(!q) return loadVideos();
    const res=await fetch(API+'/search?keyword='+encodeURIComponent(q));
    render(await res.json());
  };

  loadCategories();
  loadVideos();
</script>
</body>
</html>
