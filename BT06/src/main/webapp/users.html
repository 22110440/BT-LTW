<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Users</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">
<h1 class="mb-4">User Management</h1>

<form id="formUser" class="mb-3">
  <input type="hidden" id="id">
  <div class="mb-2">
    <label class="form-label">Username</label>
    <input type="text" id="username" class="form-control" required>
  </div>
  <div class="mb-2">
    <label class="form-label">Password</label>
    <input type="password" id="password" class="form-control" required>
  </div>
  <div class="mb-2">
    <label class="form-label">Role</label>
    <select id="role" class="form-select">
      <option value="USER">USER</option>
      <option value="ADMIN">ADMIN</option>
    </select>
  </div>
  <button type="submit" class="btn btn-primary">Save</button>
</form>

<input type="text" id="search" class="form-control mb-3" placeholder="Search by username...">

<table class="table table-bordered">
  <thead>
  <tr><th>ID</th><th>Username</th><th>Role</th><th>Actions</th></tr>
  </thead>
  <tbody id="tblUsers"></tbody>
</table>

<script>
  const API = '/api/users';

  async function loadUsers() {
    const res = await fetch(API);
    render(await res.json());
  }

  function render(data) {
    const tbody = document.getElementById('tblUsers');
    tbody.innerHTML='';
    data.forEach(u=>{
      tbody.innerHTML += `
    <tr>
      <td>${u.id}</td>
      <td>${u.username}</td>
      <td>${u.role}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="edit(${u.id})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="remove(${u.id})">Delete</button>
      </td>
    </tr>`;
    });
  }

  document.getElementById('formUser').onsubmit = async (e)=>{
    e.preventDefault();
    const id = document.getElementById('id').value;
    const payload = {
      username: document.getElementById('username').value,
      password: document.getElementById('password').value,
      role: document.getElementById('role').value
    };
    await fetch(id?API+'/'+id:API,{
      method:id?'PUT':'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    e.target.reset(); document.getElementById('id').value='';
    loadUsers();
  };

  async function edit(id){
    const res= await fetch(API+'/'+id);
    const u = await res.json();
    document.getElementById('id').value=u.id;
    document.getElementById('username').value=u.username;
    document.getElementById('password').value='';
    document.getElementById('role').value=u.role;
  }

  async function remove(id){
    if(confirm('Delete?')) {
      await fetch(API+'/'+id,{method:'DELETE'});
      loadUsers();
    }
  }

  document.getElementById('search').oninput=async(e)=>{
    const q=e.target.value;
    if(!q) return loadUsers();
    const res=await fetch(API+'/search?keyword='+encodeURIComponent(q));
    render(await res.json());
  };

  loadUsers();
</script>
</body>
</html>
