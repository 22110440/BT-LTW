<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang chủ User - GraphQL Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .navbar {
            background: rgba(255,255,255,0.95) !important;
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        .card { 
            margin-bottom: 15px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            border-radius: 15px;
        }
        .card:hover { transform: translateY(-2px); }
        .hero-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        .product-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .price-badge {
            font-size: 1.1em;
            font-weight: bold;
        }
        .category-filter {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .user-info {
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-store text-primary me-2"></i>
                <strong>GraphQL Shop</strong>
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-1"></i>
                        <span id="userName">User</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- User Welcome Section -->
        <div class="user-info">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-1">
                        <i class="fas fa-home text-success me-2"></i>
                        Chào mừng, <span id="userFullname">User</span>!
                    </h4>
                    <p class="text-muted mb-0">Khám phá các sản phẩm tuyệt vời trong cửa hàng của chúng tôi</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="badge bg-success fs-6">
                        <i class="fas fa-user me-1"></i>Khách hàng
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Filter -->
        <div class="category-filter">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-2">
                        <i class="fas fa-filter text-primary me-2"></i>Lọc theo danh mục
                    </h5>
                    <div class="input-group">
                        <select class="form-select" id="categorySelect">
                            <option value="">Tất cả danh mục</option>
                        </select>
                        <button class="btn btn-primary" onclick="filterByCategory()">
                            <i class="fas fa-search"></i> Lọc
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-end align-items-center">
                        <button class="btn btn-outline-info me-2" onclick="loadAllProducts()">
                            <i class="fas fa-list"></i> Tất cả sản phẩm
                        </button>
                        <button class="btn btn-outline-success" onclick="loadProductsByPrice()">
                            <i class="fas fa-sort-amount-up"></i> Giá tăng dần
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">
                    <i class="fas fa-shopping-bag me-2"></i>
                    <span id="productsTitle">Sản phẩm nổi bật</span>
                </h3>
            </div>
            <div class="card-body">
                <div id="products-loading" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                </div>
                <div id="products" class="row"></div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-box fa-2x mb-2"></i>
                        <h4 id="total-products">-</h4>
                        <p>Tổng sản phẩm</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-tags fa-2x mb-2"></i>
                        <h4 id="total-categories">-</h4>
                        <p>Danh mục</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-star fa-2x mb-2"></i>
                        <h4 id="featured-count">-</h4>
                        <p>Sản phẩm đang hiển thị</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const GQL_ENDPOINT = "/graphql";
        let currentUser = null;
        
        // Check authentication and authorization
        function checkAuth() {
            const userStr = localStorage.getItem('currentUser');
            if (!userStr) {
                alert('Bạn cần đăng nhập để truy cập trang này!');
                window.location.href = '/login.html';
                return false;
            }
            
            currentUser = JSON.parse(userStr);
            
            // Check if user has correct role (USER or ADMIN can access this page)
            if (!currentUser.role || (currentUser.role !== 'USER' && currentUser.role !== 'ADMIN')) {
                alert('Bạn không có quyền truy cập trang này!');
                window.location.href = '/login.html';
                return false;
            }
            
            // Update UI with user info
            document.getElementById('userName').textContent = currentUser.fullname || currentUser.email;
            document.getElementById('userFullname').textContent = currentUser.fullname || currentUser.email;
            
            return true;
        }
        
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = '/login.html';
        }
        
        async function gql(query, variables = {}) {
            try {
                const res = await fetch(GQL_ENDPOINT, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ query, variables })
                });
                const result = await res.json();
                if (result.errors) {
                    console.error("GraphQL errors:", result.errors);
                    throw new Error(result.errors[0].message);
                }
                return result;
            } catch (error) {
                console.error("GraphQL request failed:", error);
                throw error;
            }
        }
        
        function showLoading() {
            document.getElementById('products-loading').classList.remove('d-none');
        }
        
        function hideLoading() {
            document.getElementById('products-loading').classList.add('d-none');
        }
        
        function renderProducts(products, title = 'Sản phẩm') {
            const wrap = document.getElementById("products");
            const titleElement = document.getElementById("productsTitle");
            
            titleElement.textContent = title;
            wrap.innerHTML = "";
            
            if (!products || products.length === 0) {
                wrap.innerHTML = '<div class="col-12"><div class="alert alert-info">Không có sản phẩm nào</div></div>';
                document.getElementById('featured-count').textContent = '0';
                return;
            }
            
            products.forEach(p => {
                wrap.innerHTML += `
                    <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
                        <div class="product-card h-100">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0 fw-bold">${p.title}</h6>
                                <span class="badge bg-primary price-badge">$${p.price || 0}</span>
                            </div>
                            <p class="text-muted small mb-2">${p.desc || 'Không có mô tả'}</p>
                            <div class="row text-center small mb-2">
                                <div class="col-6">
                                    <strong>Số lượng:</strong><br>
                                    <span class="badge bg-info">${p.quantity || 0}</span>
                                </div>
                                <div class="col-6">
                                    <strong>Chủ sở hữu:</strong><br>
                                    <small>${p.owner?.fullname || 'N/A'}</small>
                                </div>
                            </div>
                            ${p.categories && p.categories.length > 0 ? `
                                <div class="mb-2">
                                    ${p.categories.map(cat => `<span class="badge bg-secondary me-1 small">${cat.name}</span>`).join('')}
                                </div>
                            ` : ''}
                            <div class="d-grid">
                                <button class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i>Xem chi tiết
                                </button>
                            </div>
                        </div>
                    </div>`;
            });
            
            document.getElementById('featured-count').textContent = products.length;
        }
        
        async function loadAllProducts() {
            showLoading();
            try {
                const query = `
                    query {
                        products {
                            id title price quantity desc
                            owner { fullname }
                            categories { name }
                        }
                    }`;
                const { data } = await gql(query);
                renderProducts(data.products, 'Tất cả sản phẩm');
            } catch (error) {
                document.getElementById("products").innerHTML = 
                    `<div class="col-12"><div class="alert alert-danger">Lỗi tải sản phẩm: ${error.message}</div></div>`;
            } finally {
                hideLoading();
            }
        }
        
        async function loadProductsByPrice() {
            showLoading();
            try {
                const query = `
                    query {
                        productsByPriceAsc {
                            id title price quantity desc
                            owner { fullname }
                            categories { name }
                        }
                    }`;
                const { data } = await gql(query);
                renderProducts(data.productsByPriceAsc, 'Sản phẩm (Giá tăng dần)');
            } catch (error) {
                document.getElementById("products").innerHTML = 
                    `<div class="col-12"><div class="alert alert-danger">Lỗi tải sản phẩm: ${error.message}</div></div>`;
            } finally {
                hideLoading();
            }
        }
        
        async function filterByCategory() {
            const categoryId = document.getElementById("categorySelect").value;
            
            if (!categoryId) {
                loadAllProducts();
                return;
            }
            
            showLoading();
            try {
                const query = `
                    query($cid: ID!) {
                        productsByCategory(categoryId: $cid) {
                            id title price quantity desc
                            owner { fullname }
                            categories { name }
                        }
                    }`;
                const { data } = await gql(query, { cid: categoryId });
                const selectedCategory = document.getElementById("categorySelect").selectedOptions[0].text;
                renderProducts(data.productsByCategory, `Sản phẩm - ${selectedCategory}`);
            } catch (error) {
                document.getElementById("products").innerHTML = 
                    `<div class="col-12"><div class="alert alert-danger">Lỗi tải sản phẩm: ${error.message}</div></div>`;
            } finally {
                hideLoading();
            }
        }
        
        async function loadCategories() {
            try {
                const query = `
                    query {
                        categories {
                            id name
                            products { id }
                        }
                    }`;
                const { data } = await gql(query);
                const select = document.getElementById("categorySelect");
                
                // Clear existing options except "Tất cả danh mục"
                select.innerHTML = '<option value="">Tất cả danh mục</option>';
                
                if (data.categories && data.categories.length > 0) {
                    data.categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = `${cat.name || 'Không tên'} (${cat.products?.length || 0} sản phẩm)`;
                        select.appendChild(option);
                    });
                }
                
                document.getElementById('total-categories').textContent = data.categories?.length || 0;
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        async function loadStatistics() {
            try {
                const query = `
                    query {
                        products { id }
                        categories { id }
                    }`;
                const { data } = await gql(query);
                
                document.getElementById('total-products').textContent = data.products?.length || 0;
                document.getElementById('total-categories').textContent = data.categories?.length || 0;
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;
            
            loadProductsByPrice(); // Load products by price as default
            loadCategories();
            loadStatistics();
        });
    </script>
</body>
</html>
